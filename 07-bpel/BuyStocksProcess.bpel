<?xml version="1.0" encoding="utf-8" ?>
<bpel:process name="BuyStocksProcess"
    targetNamespace="http://BuyStocks/bpel" 
    xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:tns="http://BuyStocks/bpel"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:tnswsdl="http://BuyStocks/wsdl"
    xmlns:tnsxsd="http://BuyStocks/xsd"
    queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"
    expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"
    xmlns:sm="http://stockmarket/"
    >

  <bpel:import location="BuyStocksProcess.wsdl"
      namespace="http://BuyStocks/wsdl"
      importType="http://schemas.xmlsoap.org/wsdl/" />
  
  <bpel:partnerLinks>
    <bpel:partnerLink name="BuyStocksLink" 
        partnerLinkType="tnswsdl:BuyStocksLinkType" 
        myRole="BuyStocksExecutorRole" />
    <bpel:partnerLink name="BuyStocksFromStockMarketLink" 
      partnerLinkType="tnswsdl:BuyStocksFromStockMarketLinkType" 
      myRole="BuyStocksFromStockMarketClientRole"
      partnerRole="StockMarketRole" />
  </bpel:partnerLinks>

  <bpel:variables>
    <bpel:variable name="buyStocksInputMessage" messageType="tnswsdl:BuyStocksInputMessage" />
    <bpel:variable name="buyStocksInElement" element="tnswsdl:BuyStocksIn" />
    <bpel:variable name="stockMarketBuyStocksRequestElement" element="sm:BuyStocks" />
    <bpel:variable name="stockMarketBuyStocksRequestMessage" messageType="sm:BuyStocks" />
    <bpel:variable name="stockMarketBuyStocksResponseMessage" messageType="sm:BuyStocksResponse" />
    <bpel:variable name="stockMarketBuyStocksResponseElement" element="sm:BuyStocksResponse" />


    <!-- <variable name="inputNumber" type="xsd:integer" />
    <variable name="multiplyRequestElement" element="c:Multiply"/>
    <variable name="multiplyRequestMessage" messageType="c:MultiplySoapIn"/>
    <variable name="multiplyResponseMessage" messageType="c:MultiplySoapOut"/>
    <variable name="multiplyResponseElement" element="c:MultiplyResponse"/> -->
    <bpel:variable name="outputMessage" messageType="tnswsdl:BuyStocksOutputMessage" />
  </bpel:variables>
  
  <bpel:sequence>
  
    <bpel:receive
        name="ReceiveBuyStocksInputs"
        partnerLink="BuyStocksLink"
        portType="tnswsdl:StocksPortType"
        operation="BuyStocksOperation"
        variable="buyStocksInputMessage"
        createInstance="yes" />

    <bpel:assign name="ParseInput">
    	<bpel:copy>
    		<bpel:from variable="buyStocksInputMessage" part="parameters"/>
    		<bpel:to variable="buyStocksInElement"/>
    	</bpel:copy>
    </bpel:assign>

    <bpel:assign name="InitStockMarketBuyStocksRequestMessage">
      <bpel:copy>
        <bpel:from>
          <bpel:literal>
            <sm:BuyStocks>
              <arg0></arg0>
              <arg1></arg1>
            </sm:BuyStocks>
          </bpel:literal>
        </bpel:from>
        <bpel:to variable="stockMarketBuyStocksRequestElement" />
      </bpel:copy>
      <bpel:copy>
        <bpel:from>$buyStocksInElement/stock[1]/stockId</bpel:from>
        <bpel:to>$stockMarketBuyStocksRequestElement/arg0</bpel:to>
      </bpel:copy>
      <bpel:copy>
        <bpel:from>$buyStocksInElement/stock[1]/stockCount</bpel:from>
        <bpel:to>$stockMarketBuyStocksRequestElement/arg1</bpel:to>
      </bpel:copy>
      <bpel:copy>
        <bpel:from variable="stockMarketBuyStocksRequestElement" />
        <bpel:to variable="stockMarketBuyStocksRequestMessage" part="parameters" />
      </bpel:copy>
    </bpel:assign>


    <bpel:invoke
        name="BuyStocksFromStockMarketInvoke"
        partnerLink="BuyStocksFromStockMarketLink"
        operation="BuyStocks"
        inputVariable="stockMarketBuyStocksRequestMessage"
        outputVariable="stockMarketBuyStocksResponseMessage"
    />
    

    <!-- <assign name="CopyAssign">
      <copy>
        <from variable="multiplyResponseMessage" part="parameters"/>
        <to variable="multiplyResponseElement"/>
      </copy>
      <copy>
        <from>$multiplyResponseElement/c:MultiplyResult</from>
        <to variable="outputNumber" part="parameters" />
      </copy>
    </assign> -->

    <bpel:assign>
        <bpel:copy>
            <bpel:from> 
                <bpel:literal>
                    <tns:BuyStocksOut>
                        <tns:storeMessage>Stored Dummy</tns:storeMessage>
                    </tns:BuyStocksOut>

                </bpel:literal>
            </bpel:from>
            <bpel:to variable="outputMessage" part="parameters"/>
        </bpel:copy>
    </bpel:assign>
    
    <bpel:reply name="ReplyBuyStocksOutputs"  
        partnerLink="BuyStocksLink"
        portType="tnswsdl:StocksPortType" 
        operation="BuyStocksOperation"
        variable="outputMessage" />
    
  </bpel:sequence>
  
</bpel:process>