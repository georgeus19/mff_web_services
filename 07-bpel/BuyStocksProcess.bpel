<?xml version="1.0" encoding="utf-8" ?>
<bpel:process name="BuyStocksProcess"
    targetNamespace="http://BuyStocks/bpel" 
    xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:tns="http://BuyStocks/bpel"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:tnswsdl="http://BuyStocks/wsdl"
    xmlns:tnsxsd="http://BuyStocks/xsd"
    queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"
    expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"
    xmlns:sm="http://stockmarket/"
    xmlns:cust="http://custodian/"
    >

  <bpel:import location="BuyStocksProcess.wsdl"
      namespace="http://BuyStocks/wsdl"
      importType="http://schemas.xmlsoap.org/wsdl/" />
  
  <bpel:partnerLinks>
    <bpel:partnerLink name="BuyStocksLink" 
        partnerLinkType="tnswsdl:BuyStocksLinkType" 
        myRole="BuyStocksExecutorRole" />
    <bpel:partnerLink name="BuyStocksFromStockMarketLink" 
      partnerLinkType="tnswsdl:BuyStocksFromStockMarketLinkType" 
      myRole="BuyStocksFromStockMarketClientRole"
      partnerRole="StockMarketRole" />
    <bpel:partnerLink name="StoreStocksAtCustodianLink" 
      partnerLinkType="tnswsdl:StoreStocksAtCustodianLinkType" 
      myRole="StoreStocksAtCustodianClientRole"
      partnerRole="CustodianRole" />
  </bpel:partnerLinks>

  <bpel:variables>
    <bpel:variable name="buyStocksInputMessage" messageType="tnswsdl:BuyStocksInputMessage" />
    <bpel:variable name="buyStocksInElement" element="tnswsdl:BuyStocksIn" />

    <bpel:variable name="stockMarketBuyStocksRequestElement" element="sm:BuyStocks" />
    <bpel:variable name="stockMarketBuyStocksRequestMessage" messageType="sm:BuyStocks" />
    <bpel:variable name="stockMarketBuyStocksResponseMessage" messageType="sm:BuyStocksResponse" />
    <bpel:variable name="stockMarketBuyStocksResponseElement" element="sm:BuyStocksResponse" />

    <bpel:variable name="custodianStoreStocksRequestElement" element="cust:StoreStock" />
    <bpel:variable name="custodianStoreStocksRequestMessage" messageType="cust:StoreStock" />
    <bpel:variable name="custodianStoreStocksResponseMessage" messageType="cust:StoreStockResponse" />
    <bpel:variable name="custodianStoreStocksResponseElement" element="cust:StoreStockResponse" />

    <bpel:variable name="buyStocksOutputElement" element="tnswsdl:BuyStocksOut" />
    <bpel:variable name="buyStocksOutputMessage" messageType="tnswsdl:BuyStocksOutputMessage" />
  </bpel:variables>
  
  <bpel:sequence>
  
    <bpel:receive
        name="ReceiveBuyStocksInputs"
        partnerLink="BuyStocksLink"
        portType="tnswsdl:StocksPortType"
        operation="BuyStocksOperation"
        variable="buyStocksInputMessage"
        createInstance="yes" />

    <bpel:assign name="ParseInput">
    	<bpel:copy>
    		<bpel:from variable="buyStocksInputMessage" part="parameters"/>
    		<bpel:to variable="buyStocksInElement"/>
    	</bpel:copy>
    </bpel:assign>

    <bpel:assign name="InitStockMarketBuyStocksRequestMessage">
      <bpel:copy>
        <bpel:from>
          <bpel:literal>
            <sm:BuyStocks>
              <arg0></arg0>
              <arg1></arg1>
            </sm:BuyStocks>
          </bpel:literal>
        </bpel:from>
        <bpel:to variable="stockMarketBuyStocksRequestElement" />
      </bpel:copy>
      <bpel:copy>
        <bpel:from>$buyStocksInElement/stock[1]/stockId</bpel:from>
        <bpel:to>$stockMarketBuyStocksRequestElement/arg0</bpel:to>
      </bpel:copy>
      <bpel:copy>
        <bpel:from>$buyStocksInElement/stock[1]/stockCount</bpel:from>
        <bpel:to>$stockMarketBuyStocksRequestElement/arg1</bpel:to>
      </bpel:copy>
      <bpel:copy>
        <bpel:from variable="stockMarketBuyStocksRequestElement" />
        <bpel:to variable="stockMarketBuyStocksRequestMessage" part="parameters" />
      </bpel:copy>
    </bpel:assign>


    <bpel:invoke
        name="BuyStocksFromStockMarketInvoke"
        partnerLink="BuyStocksFromStockMarketLink"
        operation="BuyStocks"
        inputVariable="stockMarketBuyStocksRequestMessage"
        outputVariable="stockMarketBuyStocksResponseMessage"
    />

    <bpel:assign name="ParseStockMarketReponseMessage">
        <bpel:copy>
            <bpel:from variable="stockMarketBuyStocksResponseMessage" part="parameters" />
            <bpel:to variable="stockMarketBuyStocksResponseElement" />
        </bpel:copy>
    </bpel:assign>

    <bpel:assign name="InitCustodianStoreStocksRequestMessage">
      <bpel:copy>
        <bpel:from>
          <bpel:literal>
            <cust:StoreStock>
              <arg0></arg0>
            </cust:StoreStock>
          </bpel:literal>
        </bpel:from>
        <bpel:to variable="custodianStoreStocksRequestElement" />
      </bpel:copy>
      <bpel:copy>
        <bpel:from>$stockMarketBuyStocksResponseElement/return/stock/id</bpel:from>
        <bpel:to>$custodianStoreStocksRequestElement/arg0</bpel:to>
      </bpel:copy>
      <bpel:copy>
        <bpel:from variable="custodianStoreStocksRequestElement" />
        <bpel:to variable="custodianStoreStocksRequestMessage" part="parameters" />
      </bpel:copy>
    </bpel:assign>
    
    <bpel:invoke
        name="StoreStocksAtCustodianInvoke"
        partnerLink="StoreStocksAtCustodianLink"
        operation="StoreStock"
        inputVariable="custodianStoreStocksRequestMessage"
        outputVariable="custodianStoreStocksResponseMessage"
    />

    <bpel:assign>
        <bpel:copy>
            <bpel:from> 
                <bpel:literal>
                    <tns:BuyStocksOut>
                        <tns:storeMessage></tns:storeMessage>
                    </tns:BuyStocksOut>

                </bpel:literal>
            </bpel:from>
            <bpel:to variable="buyStocksOutputElement" />
        </bpel:copy>
        <bpel:copy>
            <bpel:from variable="custodianStoreStocksResponseMessage" part="parameters"/>
            <bpel:to variable="custodianStoreStocksResponseElement"/>
        </bpel:copy>
        <bpel:copy>
            <bpel:from>$custodianStoreStocksResponseElement/return</bpel:from>
            <bpel:to>$buyStocksOutputElement/tns:storeMessage</bpel:to>
        </bpel:copy>
        <bpel:copy>
            <bpel:from variable="buyStocksOutputElement"/>
            <bpel:to variable="buyStocksOutputMessage" part="parameters"/>
        </bpel:copy>
    </bpel:assign>
    
    <bpel:reply name="ReplyBuyStocksOutputs"  
        partnerLink="BuyStocksLink"
        portType="tnswsdl:StocksPortType" 
        operation="BuyStocksOperation"
        variable="buyStocksOutputMessage" />
    
  </bpel:sequence>
  
</bpel:process>